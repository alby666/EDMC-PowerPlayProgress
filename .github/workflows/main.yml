name: Build Release

on:
  workflow_dispatch:
    inputs:
      release_number:
        description: "Release version number (e.g. 1.4.2)"
        required: true
        type: string
      dry_run:
        description: "Run without creating a GitHub release"
        required: false
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run unit tests (top-level only)
        run: |
          python - <<'PY'
          import unittest,glob,sys
          suite=unittest.TestSuite()
          for f in sorted(glob.glob('tests/test_*.py')):
              module = f.replace('/', '.')
              module = module[:-3]  # strip .py
              suite.addTests(unittest.defaultTestLoader.loadTestsFromName(module))
          res=unittest.TextTestRunner().run(suite)
          sys.exit(not res.wasSuccessful())
          PY

  build-release:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0   # required for changelog generation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update plugin_version in consts.py
        run: |
          sed -i "s/^plugin_version *= *.*/plugin_version = \"${{ github.event.inputs.release_number }}\"/" consts.py

      - name: Commit version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add consts.py
          git commit -m "Bump version to ${{ github.event.inputs.release_number }}"
          git push

      - name: Install changelog generator
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev
          sudo gem install github_changelog_generator

      - name: Generate CHANGELOG.md
        env:
          CHANGELOG_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          github_changelog_generator \
            --user ${{ github.repository_owner }} \
            --project ${{ github.event.repository.name }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --future-release ${{ github.event.inputs.release_number }}

      - name: Commit changelog
        run: |
          git add CHANGELOG.md
          git commit -m "Update changelog for ${{ github.event.inputs.release_number }}"
          git push

      - name: Zip src folder
        run: |
          cd src
          zip -r ../EDMC-PowerPlayProgress.zip .

      - name: Create Release (skipped in dry-run mode)
        if: ${{ github.event.inputs.dry_run == 'false' }}
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_number }}
          name: Release ${{ github.event.inputs.release_number }}
          generate_release_notes: true
          files: EDMC-PowerPlayProgress.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}