name: Build Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run without creating a GitHub release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip and setuptools
        run: |
          pip install --upgrade pip setuptools

      - name: Install dependencies
        run: |
          cd src
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run unit tests (top-level only)
        run: |
          python - <<'PY'
          import unittest,glob,sys
          suite=unittest.TestSuite()
          for f in sorted(glob.glob('tests/test_*.py')):
              module = f.replace('/', '.')
              module = module[:-3]  # strip .py
              suite.addTests(unittest.defaultTestLoader.loadTestsFromName(module))
          res=unittest.TextTestRunner().run(suite)
          sys.exit(not res.wasSuccessful())
          PY

  build-release:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Read current version and increment patch
        id: version
        run: |
          current=$(grep -oP "plugin_version.*?['\"\`]\K[^'\"\`]+" src/consts.py)
          echo "Current version: $current"

          IFS='.' read -r major minor patch <<< "$current"
          new_patch=$((patch + 1))
          new_version="${major}.${minor}.${new_patch}"
          echo "New version: $new_version"

          echo "version=$new_version" >> "$GITHUB_OUTPUT"

      - name: Update plugin_version in src/consts.py
        run: |
          sed -i "s/^plugin_version.*/plugin_version: str = '${{ steps.version.outputs.version }}'/" src/consts.py

      - name: Commit version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add src/consts.py
          git commit -m "Bump version to ${{ steps.version.outputs.version }}"
          git push

      - name: Rename src folder and create zip
        run: |
          cp -r src EDMC-PowerPlayProgress
          zip -r EDMC-PowerPlayProgress.zip EDMC-PowerPlayProgress

      - name: Virus scan
        id: virus_scan
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq clamav > /dev/null 2>&1
          sudo freshclam --quiet || true

          echo "## ClamAV Virus Scan Results" > virus_scan_results.txt
          echo '```' >> virus_scan_results.txt
          clamscan --infected --recursive EDMC-PowerPlayProgress.zip >> virus_scan_results.txt 2>&1 || true
          echo '```' >> virus_scan_results.txt

          cat virus_scan_results.txt

          {
            echo "scan_results<<SCAN_EOF"
            cat virus_scan_results.txt
            echo "SCAN_EOF"
          } >> "$GITHUB_OUTPUT"

          if clamscan --infected --recursive EDMC-PowerPlayProgress.zip 2>&1 | grep -q "Infected files: 0"; then
            echo "scan_passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "scan_passed=false" >> "$GITHUB_OUTPUT"
            echo "::error::Virus scan detected infected files!"
          fi

      - name: Create Release
        if: ${{ github.event.inputs.dry_run != 'true' && steps.virus_scan.outputs.scan_passed == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          generate_release_notes: true
          body: |
            ${{ steps.virus_scan.outputs.scan_results }}
          files: EDMC-PowerPlayProgress.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}